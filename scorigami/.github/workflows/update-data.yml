name: Update Premier League Data

on:
  schedule:
    # Run every Sunday at 11 PM GMT (23:00 UTC)
    - cron: '0 23 * * 0'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('DESCRIPTION') }}
          restore-keys: ${{ runner.os }}-r-

      - name: Install R dependencies
        run: |
          install.packages(c('tidyverse', 'lubridate'))
        shell: Rscript {0}

      - name: Run data update script
        run: Rscript update_data.R

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet pl_history.rds || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add pl_history.rds
          git commit -m "ðŸ¤– Auto-update: Premier League data ($(date +'%Y-%m-%d'))"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ“Š Data Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify_diff.outputs.changed }}" == "true" ]; then
            echo "- **Changes:** New data added" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Changes:** No new matches found" >> $GITHUB_STEP_SUMMARY
          fi
