name: Update Premier League Data

on:
  schedule:
    # Run every Sunday at 11 PM GMT (23:00 UTC)
    - cron: '0 23 * * 0'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Install R dependencies
        run: |
          install.packages(c('dplyr', 'tidyr', 'readr', 'purrr', 'stringr', 'ggplot2', 'lubridate', 'rsconnect'), repos = 'https://cloud.r-project.org', dependencies = TRUE)
        shell: Rscript {0}

      - name: Run data update script
        run: |
          cd scorigami
          Rscript update_data.R

      - name: Check for changes
        id: verify_diff
        run: |
          cd scorigami
          git diff --quiet pl_history.rds || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          cd scorigami
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add pl_history.rds
          git commit -m "ðŸ¤– Auto-update: Premier League data ($(date +'%Y-%m-%d'))"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to shinyapps.io
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          cd scorigami
          Rscript -e "
            library(rsconnect)

            # Configure shinyapps.io account
            rsconnect::setAccountInfo(
              name   = '${{ secrets.SHINYAPPS_ACCOUNT }}',
              token  = '${{ secrets.SHINYAPPS_TOKEN }}',
              secret = '${{ secrets.SHINYAPPS_SECRET }}'
            )

            # Deploy the app
            rsconnect::deployApp(
              appName = 'premier-league-scorigami',
              account = '${{ secrets.SHINYAPPS_ACCOUNT }}',
              forceUpdate = TRUE,
              launch.browser = FALSE
            )

            cat('\nâœ… Deployed to shinyapps.io\n')
          "

      - name: Summary
        run: |
          echo "## ðŸ“Š Data Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify_diff.outputs.changed }}" == "true" ]; then
            echo "- **Changes:** New data added and deployed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Changes:** No new matches found" >> $GITHUB_STEP_SUMMARY
          fi
